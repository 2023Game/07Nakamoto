#pragma once
#include "CEnemy.h"

// 視野範囲のデバッグ表示クラスの前宣言
class CDebugFieldOfView;

class CInteractObject;
class CNavNode;

// ウォーロックの敵クラス
class CBoss : public CEnemy
{
public:
	// インスタンスのポインタを取得
	static CBoss* Instance();

	// コンストラクタ
	CBoss(std::vector<std::vector<CVector>> patrolPoints);
	// デストラクタ
	~CBoss();

	// 攻撃中か
	bool IsAttacking() const override;
	// 攻撃開始
	void AttackStart() override;
	// 攻撃終了
	void AttackEnd() override;

	// 妖力の源の減少
	void PowerDown();

	// ダメージを受ける
	void TakeDamage(int damage, CObjectBase* causer) override;
	// 死亡
	void Death() override;
	// 衝突処理
	void Collision(CCollider* self, CCollider* other, const CHitInfo& hit) override;

	// オブジェクト削除を伝える関数
	void DeleteObject(CObjectBase* obj) override;

	// 更新
	void Update() override;
	// 描画
	void Render() override;

private:
	// ウォーロックのインスタンス
	static CBoss* spInstance;

	// アニメーションの種類
	enum class EAnimType
	{
		None = -1,

		eIdle,		// 待機
		eWalk,		// 歩行
		eRun,		// 走行
		eAttack,	// 攻撃
		eAlert,		// 警戒

		Num			// アニメーションの種類の数
	};

	// プレイヤーの状態
	enum class EState
	{
		eIdle,		// 待機
		ePatrol,	// 巡回中
		eChase,		// プレイヤーを追いかける
		eLost,		// プレイヤーを見失う
		eAttack,	// プレイヤー攻撃
		eAlert,
		eDeath,		// 死亡
	};

	// 状態切り替え
	void ChangeState(int state) override;

	// 現在の戦闘相手を取得
	CObjectBase* GetBattleTarget() const;

	// 戦闘相手の方へ向く
	void LookAtBattleTarget(bool immediate = false);

	// 頭の正面方向ベクトルを取得
	CVector GetHeadForwardVec() const;

	// 指定したターゲットが視野範囲内に入ったかどうか
	bool IsFoundTarget(CObjectBase* target) const;
	// 現在位置からターゲットが見えているかどうか
	bool IsLookTarget(CObjectBase* target) const;
	// 戦闘相手を攻撃できるかどうか
	bool CanAttackBattleTarget() const;
	// 壊せるオブジェクトを攻撃するか確認
	bool CheckAttackBreakObj();
	// キャラクターを攻撃するか確認
	bool CheckAttackChara();
	// 戦闘相手の死亡確認をして、戦闘相手がまだ存在するか確認
	CObjectBase* ChackDeathBattleTargets();

	// 指定した位置まで移動する
	bool MoveTo(const CVector& targetPos, float speed);
	// 次に巡回するポイントを変更する
	bool ChangePatrolPoint();
	// 巡回ルートを更新する
	bool UpdatePatrolRoute();

	// 待機状態の更新処理
	void UpdateIdle();
	// 巡回中の更新処理
	void UpdatePatrol();
	// 追いかける時の更新処理
	void UpdateChase();
	// プレイヤーを見失った時の更新処理
	void UpdateLost();
	// 警戒している時の処理
	void UpdateAlert();
	// パンチ攻撃時の更新処理
	void UpdateAttack1();
	// 針攻撃時の更新処理
	void UpdateAttack2();
	// 仰け反り状態の更新処理
	void UpdateHit();
	// 死亡状態の更新処理
	void UpdateDeath();

	// 状態の文字列を取得
	std::string GetStateStr(EState state) const;
	// 状態の色を取得
	CColor GetStateColor(EState state) const;

	float mFovAngle;	// 視野範囲の角度
	float mFovLength;	// 視野範囲の距離

#if _DEBUG
	CDebugFieldOfView* mpDebugFov;	// 視野範囲のデバッグ表示
	CMatrix mHeadForwardMtx;
#endif

	CNavNode* mpLostPlayerNode;	// プレイヤーを見失った位置のノード
	float mLostElapsedTime;		// 見失ってからの経過時間

	// 巡回ポイントのリスト
	std::vector<CVector>* mpCurrentPatrolRoute;
	std::vector<std::vector<CVector>> mPatrolRoutes;
	CNavNode* mpPatrolStartPoint;

	int mNextPatrolIndex;	// 次に巡回する番号

	std::vector<CNavNode*> mMoveRoute;	// 求めた最短経路記憶用
	int mNextMoveIndex;					// 次に移動するノードのインデックス値

	std::vector<CCharaBase*> mTargetCharas;	//標的のリスト

	bool mIsBattle;					// 戦闘状態か
	float mBattleIdletime;			// 戦闘時の待機時間
	CCharaBase* mpBattleTargetChara;	// 戦闘相手（キャラクター用）
	CObjectBase* mpBattleTargetObj;		// 戦闘相手（オブジェクト用）
	CCollider* mpAttack1Col;		// パンチ攻撃用のコライダー

	// 一番近くにある壊せるオブジェクトを取得
	CObjectBase* GetNearBreakObj() const;
	// 近くにある壊せるオブジェクトのリスト
	std::vector<CObjectBase*> mNearBreakObjs;
	CCollider* mpSearchCol;	// 調べるオブジェクトを探知するコライダー

	// 妖力の源の最大値
	int mMaxDemonPower;
	// 妖力の源の数
	int mDemonPower;
	// 攻撃力
	int mPower;

	// 頭の行列
	const CMatrix* mpHeadMtx;

	float mStopElapsedTime;
	CVector mLastPos;
};